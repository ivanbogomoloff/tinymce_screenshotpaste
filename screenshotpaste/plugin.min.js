tinymce.PluginManager.add('screenshotpaste', function(editor, url) {
    editor.on('paste', function (thePasteEvent) {
        var canvas = document.getElementById('pasted_img');
        if(canvas) {
		//noop...
        }
        else {
            var canvas = document.createElement("canvas");
            canvas.id = 'pasted_img';
            //canvas.style.display = 'none';
            document.body.appendChild(canvas);
        }
        var URLObj = window.URL || window.webkitURL;
        var img = new Image();


        var ctx = canvas.getContext('2d');
        img.onload = function(){
            canvas.width = this.width;
            canvas.height = this.height;

            ctx.drawImage(img, 0, 0);
            var rawImage = canvas.toDataURL();
	    // NEED JQUERY HERE :(
            // TODO replace with raw ajax
	    $.ajax({
                type:"POST",
                url: "screenshotpaste.php",
                data: {
                    dataUrl: rawImage
                },
                success: function (r) {
               
                    editor.insertContent('<!-- screenschotpaste -->' +
                        '<img style="max-width: 100%; max-height: 100%;" class="_screenshotpaste-img" src="'+r.src+'" />' +
                        '<!-- end screenshotpaset -->');
                }
            })

        };

        if(thePasteEvent.clipboardData.items)
        {
            var transferItem = false;
            for(var i in thePasteEvent.clipboardData.items) {
                /** @var DataTransferItem  transferItem */
                transferItem = thePasteEvent.clipboardData.items[i];
                switch (transferItem.kind) {
                    case 'file':
                        img.src = URLObj.createObjectURL(transferItem.getAsFile());
                        break;
                }
            }
        }

    });
});
